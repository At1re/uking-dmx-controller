<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U`King Laser DMX Controller</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --neon-cyan: #00ffff;
            --neon-magenta: #ff00ff;
            --neon-yellow: #ffff00;
            --neon-green: #00ff00;
            --neon-red: #ff0000;
            --deep-black: #0a0a0a;
            --panel-bg: rgba(15, 15, 25, 0.95);
            --border-glow: rgba(0, 255, 255, 0.3);
        }
        
        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a2e 50%, #0a0a0a 100%);
            color: var(--neon-cyan);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(0deg, rgba(0, 255, 255, 0.03) 0px, transparent 1px, transparent 2px, rgba(0, 255, 255, 0.03) 3px),
                repeating-linear-gradient(90deg, rgba(255, 0, 255, 0.03) 0px, transparent 1px, transparent 2px, rgba(255, 0, 255, 0.03) 3px);
            pointer-events: none;
            z-index: 1;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            animation: slideDown 0.8s ease-out;
        }
        
        h1 {
            font-family: 'Orbitron', monospace;
            font-size: 3.5rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 8px;
            background: linear-gradient(45deg, var(--neon-cyan), var(--neon-magenta), var(--neon-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(0, 255, 255, 0.5);
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: var(--neon-green);
            letter-spacing: 4px;
            text-transform: uppercase;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: var(--panel-bg);
            border: 2px solid var(--border-glow);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 
                0 0 20px rgba(0, 255, 255, 0.2),
                inset 0 0 20px rgba(0, 255, 255, 0.05);
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease-out backwards;
        }
        
        .panel:hover {
            border-color: var(--neon-cyan);
            box-shadow: 
                0 0 30px rgba(0, 255, 255, 0.4),
                inset 0 0 20px rgba(0, 255, 255, 0.1);
            transform: translateY(-5px);
        }
        
        .panel h2 {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--neon-cyan);
            text-transform: uppercase;
            letter-spacing: 3px;
            border-bottom: 2px solid var(--border-glow);
            padding-bottom: 10px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95rem;
            color: var(--neon-green);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, var(--deep-black), var(--neon-cyan));
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 10px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--neon-cyan);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-cyan);
            transition: all 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--neon-magenta);
            box-shadow: 0 0 20px var(--neon-magenta);
            transform: scale(1.2);
        }
        
        .value-display {
            display: inline-block;
            background: rgba(0, 255, 255, 0.1);
            padding: 5px 15px;
            border-radius: 5px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            color: var(--neon-cyan);
            float: right;
        }
        
        .color-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .color-btn {
            padding: 15px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .color-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .color-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .color-btn.active {
            border-color: white;
            box-shadow: 0 0 20px currentColor;
            transform: scale(1.05);
        }
        
        .color-btn.red { background: var(--neon-red); color: white; }
        .color-btn.green { background: var(--neon-green); color: black; }
        .color-btn.blue { background: #0066ff; color: white; }
        .color-btn.yellow { background: var(--neon-yellow); color: black; }
        .color-btn.cyan { background: var(--neon-cyan); color: black; }
        
        .scene-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .scene-btn {
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(255, 0, 255, 0.1));
            border: 2px solid var(--border-glow);
            border-radius: 8px;
            color: var(--neon-cyan);
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .scene-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.4), transparent);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }
        
        .scene-btn:hover::after {
            width: 400px;
            height: 400px;
        }
        
        .scene-btn:hover {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            transform: translateY(-3px);
        }
        
        .scene-btn.active {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(255, 0, 255, 0.3));
            border-color: var(--neon-magenta);
            box-shadow: 0 0 40px rgba(255, 0, 255, 0.6);
        }
        
        .audio-visualizer {
            height: 120px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--border-glow);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin-top: 15px;
        }
        
        #audioCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-bg);
            border: 2px solid var(--border-glow);
            border-radius: 8px;
            padding: 15px 25px;
            margin-top: 20px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--neon-red);
            animation: pulse 2s ease-in-out infinite;
        }
        
        .status-dot.connected {
            background: var(--neon-green);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--border-glow);
            transition: 0.4s;
            border-radius: 30px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: var(--neon-red);
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--neon-red);
        }
        
        input:checked + .toggle-slider {
            background-color: rgba(0, 255, 0, 0.2);
            border-color: var(--neon-green);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(28px);
            background-color: var(--neon-green);
            box-shadow: 0 0 15px var(--neon-green);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes glow {
            from {
                text-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            }
            to {
                text-shadow: 0 0 40px rgba(0, 255, 255, 0.8), 0 0 60px rgba(255, 0, 255, 0.5);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(0.9);
            }
        }
        
        .grid .panel:nth-child(1) { animation-delay: 0.1s; }
        .grid .panel:nth-child(2) { animation-delay: 0.2s; }
        .grid .panel:nth-child(3) { animation-delay: 0.3s; }
        .grid .panel:nth-child(4) { animation-delay: 0.4s; }
        
        button#connectDMX {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta));
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            margin-bottom: 15px;
        }
        
        button#connectDMX:hover {
            transform: scale(1.05);
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.8);
        }
        
        .info-box {
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid var(--border-glow);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .info-box code {
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 3px;
            color: var(--neon-yellow);
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>U`King DMX</h1>
            <div class="subtitle">5-Beam Laser Controller</div>
        </header>

        <div class="grid">
            <!-- Connection Panel -->
            <div class="panel">
                <h2>ðŸ”Œ Connection</h2>
                <button id="connectDMX">Connect DMX Interface</button>
                <div class="info-box">
                    <strong>Setup:</strong><br>
                    1. Connect USB-DMX adapter to computer<br>
                    2. Set U`King to DMX mode (6 or 11 channel)<br>
                    3. Set starting address to <code>1</code><br>
                    4. Click "Connect DMX Interface"
                </div>
                <div class="control-group">
                    <label>DMX Start Address <span class="value-display" id="addressDisplay">1</span></label>
                    <input type="range" id="dmxAddress" min="1" max="512" value="1">
                </div>
            </div>

            <!-- Color Control Panel -->
            <div class="panel">
                <h2>ðŸŽ¨ Color Select</h2>
                <div class="color-buttons">
                    <button class="color-btn red" data-color="0">Red</button>
                    <button class="color-btn green" data-color="63">Green</button>
                    <button class="color-btn blue" data-color="127">Blue</button>
                    <button class="color-btn yellow" data-color="191">Yellow</button>
                    <button class="color-btn cyan" data-color="255">Cyan</button>
                </div>
                <div class="control-group" style="margin-top: 20px;">
                    <label>Manual Color <span class="value-display" id="colorDisplay">0</span></label>
                    <input type="range" id="colorSlider" min="0" max="255" value="0">
                </div>
            </div>

            <!-- Pattern Control Panel -->
            <div class="panel">
                <h2>âœ¨ Pattern Mode</h2>
                <div class="control-group">
                    <label>Pattern Select <span class="value-display" id="patternDisplay">0</span></label>
                    <input type="range" id="patternSlider" min="0" max="255" value="0">
                </div>
                <div class="control-group">
                    <label>Strobe Speed <span class="value-display" id="strobeDisplay">0</span></label>
                    <input type="range" id="strobeSlider" min="0" max="255" value="0">
                </div>
            </div>

            <!-- Movement Control Panel -->
            <div class="panel">
                <h2>ðŸ”„ Movement</h2>
                <div class="control-group">
                    <label>Rotation Speed <span class="value-display" id="rotationDisplay">0</span></label>
                    <input type="range" id="rotationSlider" min="0" max="255" value="0">
                </div>
                <div class="control-group">
                    <label>Master Dimmer <span class="value-display" id="dimmerDisplay">255</span></label>
                    <input type="range" id="dimmerSlider" min="0" max="255" value="255">
                </div>
            </div>
        </div>

        <!-- Scene Presets -->
        <div class="panel">
            <h2>ðŸŽ¬ Scene Presets</h2>
            <div class="scene-buttons">
                <button class="scene-btn" data-scene="blackout">â¬› Blackout</button>
                <button class="scene-btn" data-scene="fullpower">ðŸ’¥ Full Power</button>
                <button class="scene-btn" data-scene="slowrotate">ðŸŒ€ Slow Rotate</button>
                <button class="scene-btn" data-scene="faststrobe">âš¡ Fast Strobe</button>
                <button class="scene-btn" data-scene="rainbow">ðŸŒˆ Rainbow Cycle</button>
                <button class="scene-btn" data-scene="chaos">ðŸ”¥ Chaos Mode</button>
            </div>
        </div>

        <!-- Audio Reactive -->
        <div class="panel">
            <h2>ðŸŽµ Audio Reactive</h2>
            <div class="status-item">
                <label>Audio Input</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="audioToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="audio-visualizer">
                <canvas id="audioCanvas"></canvas>
            </div>
            <div class="control-group" style="margin-top: 15px;">
                <label>Bass Sensitivity <span class="value-display" id="sensitivityDisplay">50</span></label>
                <input type="range" id="sensitivitySlider" min="1" max="100" value="50">
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="dmxStatus"></div>
                <span id="dmxStatusText">DMX: Disconnected</span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="audioStatus"></div>
                <span id="audioStatusText">Audio: Inactive</span>
            </div>
            <div class="status-item">
                <span id="fpsCounter">FPS: 0</span>
            </div>
        </div>
    </div>

    <script>
        // DMX Controller State
        const state = {
            dmxConnected: false,
            audioActive: false,
            dmxAddress: 1,
            channels: {
                color: 0,      // CH1
                pattern: 0,    // CH2
                strobe: 0,     // CH3
                rotation: 0,   // CH4
                dimmer: 255,   // CH5
                mode: 0        // CH6
            },
            currentScene: null,
            audioContext: null,
            analyser: null,
            dataArray: null,
            animationFrame: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            setupEventListeners();
            setupAudioVisualizer();
            startAnimationLoop();
        }

        function setupEventListeners() {
            // DMX Connection
            document.getElementById('connectDMX').addEventListener('click', connectDMX);
            document.getElementById('dmxAddress').addEventListener('input', (e) => {
                state.dmxAddress = parseInt(e.target.value);
                document.getElementById('addressDisplay').textContent = e.target.value;
            });

            // Color Controls
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    const colorValue = parseInt(e.target.dataset.color);
                    state.channels.color = colorValue;
                    document.getElementById('colorSlider').value = colorValue;
                    document.getElementById('colorDisplay').textContent = colorValue;
                    sendDMX();
                });
            });

            document.getElementById('colorSlider').addEventListener('input', (e) => {
                state.channels.color = parseInt(e.target.value);
                document.getElementById('colorDisplay').textContent = e.target.value;
                sendDMX();
            });

            // Pattern Controls
            document.getElementById('patternSlider').addEventListener('input', (e) => {
                state.channels.pattern = parseInt(e.target.value);
                document.getElementById('patternDisplay').textContent = e.target.value;
                sendDMX();
            });

            document.getElementById('strobeSlider').addEventListener('input', (e) => {
                state.channels.strobe = parseInt(e.target.value);
                document.getElementById('strobeDisplay').textContent = e.target.value;
                sendDMX();
            });

            // Movement Controls
            document.getElementById('rotationSlider').addEventListener('input', (e) => {
                state.channels.rotation = parseInt(e.target.value);
                document.getElementById('rotationDisplay').textContent = e.target.value;
                sendDMX();
            });

            document.getElementById('dimmerSlider').addEventListener('input', (e) => {
                state.channels.dimmer = parseInt(e.target.value);
                document.getElementById('dimmerDisplay').textContent = e.target.value;
                sendDMX();
            });

            // Scene Buttons
            document.querySelectorAll('.scene-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.scene-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    const scene = e.target.dataset.scene;
                    activateScene(scene);
                });
            });

            // Audio Toggle
            document.getElementById('audioToggle').addEventListener('change', (e) => {
                if (e.target.checked) {
                    startAudioReactive();
                } else {
                    stopAudioReactive();
                }
            });

            document.getElementById('sensitivitySlider').addEventListener('input', (e) => {
                document.getElementById('sensitivityDisplay').textContent = e.target.value;
            });
        }

        async function connectDMX() {
            // In a real implementation, this would use Web Serial API or a local server
            // to communicate with the USB-DMX interface
            console.log('DMX Connection requested...');
            
            // Simulate connection for demo
            setTimeout(() => {
                state.dmxConnected = true;
                document.getElementById('dmxStatus').classList.add('connected');
                document.getElementById('dmxStatusText').textContent = 'DMX: Connected';
                document.getElementById('connectDMX').textContent = 'DMX Connected âœ“';
                document.getElementById('connectDMX').style.background = 'linear-gradient(135deg, #00ff00, #00aa00)';
                
                // Show implementation note
                alert('DMX Connection Simulated!\n\nTo actually control your lights:\n\n1. Install a local DMX server (example code below)\n2. Connect USB-DMX adapter\n3. The server will relay commands to your hardware\n\nSee the Python server file included with this controller.');
            }, 500);
        }

        function sendDMX() {
            if (!state.dmxConnected) {
                console.log('DMX not connected');
                return;
            }

            // Build DMX packet for U`King 6-channel mode
            const dmxData = {
                startAddress: state.dmxAddress,
                channels: [
                    state.channels.color,     // CH1: Color
                    state.channels.pattern,   // CH2: Pattern
                    state.channels.strobe,    // CH3: Strobe
                    state.channels.rotation,  // CH4: Rotation
                    state.channels.dimmer,    // CH5: Dimmer
                    state.channels.mode       // CH6: Mode
                ]
            };

            // In production, send to local DMX server via WebSocket or HTTP
            console.log('Sending DMX:', dmxData);
            
            // Example: Send to local server
            // fetch('http://localhost:8080/dmx', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify(dmxData)
            // });
        }

        function activateScene(sceneName) {
            state.currentScene = sceneName;
            
            const scenes = {
                blackout: {
                    color: 0,
                    pattern: 0,
                    strobe: 0,
                    rotation: 0,
                    dimmer: 0,
                    mode: 0
                },
                fullpower: {
                    color: 255,
                    pattern: 0,
                    strobe: 0,
                    rotation: 128,
                    dimmer: 255,
                    mode: 0
                },
                slowrotate: {
                    color: 127,
                    pattern: 50,
                    strobe: 0,
                    rotation: 60,
                    dimmer: 200,
                    mode: 0
                },
                faststrobe: {
                    color: 0,
                    pattern: 100,
                    strobe: 240,
                    rotation: 200,
                    dimmer: 255,
                    mode: 0
                },
                rainbow: {
                    color: 128,
                    pattern: 150,
                    strobe: 0,
                    rotation: 100,
                    dimmer: 255,
                    mode: 0
                },
                chaos: {
                    color: 255,
                    pattern: 255,
                    strobe: 200,
                    rotation: 255,
                    dimmer: 255,
                    mode: 0
                }
            };

            const scene = scenes[sceneName];
            if (scene) {
                Object.assign(state.channels, scene);
                updateUIFromState();
                sendDMX();
                
                // Rainbow cycle animation
                if (sceneName === 'rainbow') {
                    startRainbowCycle();
                }
            }
        }

        function updateUIFromState() {
            document.getElementById('colorSlider').value = state.channels.color;
            document.getElementById('colorDisplay').textContent = state.channels.color;
            document.getElementById('patternSlider').value = state.channels.pattern;
            document.getElementById('patternDisplay').textContent = state.channels.pattern;
            document.getElementById('strobeSlider').value = state.channels.strobe;
            document.getElementById('strobeDisplay').textContent = state.channels.strobe;
            document.getElementById('rotationSlider').value = state.channels.rotation;
            document.getElementById('rotationDisplay').textContent = state.channels.rotation;
            document.getElementById('dimmerSlider').value = state.channels.dimmer;
            document.getElementById('dimmerDisplay').textContent = state.channels.dimmer;
        }

        let rainbowInterval = null;
        function startRainbowCycle() {
            if (rainbowInterval) clearInterval(rainbowInterval);
            
            let hue = 0;
            rainbowInterval = setInterval(() => {
                if (state.currentScene !== 'rainbow') {
                    clearInterval(rainbowInterval);
                    return;
                }
                
                state.channels.color = hue;
                hue = (hue + 5) % 256;
                document.getElementById('colorSlider').value = state.channels.color;
                document.getElementById('colorDisplay').textContent = state.channels.color;
                sendDMX();
            }, 100);
        }

        async function startAudioReactive() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                state.analyser = state.audioContext.createAnalyser();
                const source = state.audioContext.createMediaStreamSource(stream);
                
                state.analyser.fftSize = 256;
                const bufferLength = state.analyser.frequencyBinCount;
                state.dataArray = new Uint8Array(bufferLength);
                
                source.connect(state.analyser);
                
                state.audioActive = true;
                document.getElementById('audioStatus').classList.add('connected');
                document.getElementById('audioStatusText').textContent = 'Audio: Active';
            } catch (err) {
                console.error('Audio access denied:', err);
                document.getElementById('audioToggle').checked = false;
                alert('Microphone access denied. Please enable microphone permissions.');
            }
        }

        function stopAudioReactive() {
            if (state.audioContext) {
                state.audioContext.close();
                state.audioContext = null;
            }
            state.audioActive = false;
            document.getElementById('audioStatus').classList.remove('connected');
            document.getElementById('audioStatusText').textContent = 'Audio: Inactive';
        }

        function setupAudioVisualizer() {
            const canvas = document.getElementById('audioCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }

        let lastFrameTime = Date.now();
        let fps = 0;

        function startAnimationLoop() {
            function animate() {
                // FPS Counter
                const now = Date.now();
                const delta = now - lastFrameTime;
                fps = Math.round(1000 / delta);
                lastFrameTime = now;
                document.getElementById('fpsCounter').textContent = `FPS: ${fps}`;

                // Audio Visualizer
                if (state.audioActive && state.analyser) {
                    drawAudioVisualizer();
                    processAudioReactivity();
                }

                state.animationFrame = requestAnimationFrame(animate);
            }
            animate();
        }

        function drawAudioVisualizer() {
            const canvas = document.getElementById('audioCanvas');
            const ctx = canvas.getContext('2d');
            
            state.analyser.getByteFrequencyData(state.dataArray);
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = (canvas.width / state.dataArray.length) * 2.5;
            let x = 0;
            
            for (let i = 0; i < state.dataArray.length; i++) {
                const barHeight = (state.dataArray[i] / 255) * canvas.height;
                
                const r = barHeight + (25 * (i / state.dataArray.length));
                const g = 250 * (i / state.dataArray.length);
                const b = 255;
                
                ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                
                x += barWidth + 1;
            }
        }

        function processAudioReactivity() {
            if (!state.analyser || !state.dataArray) return;
            
            state.analyser.getByteFrequencyData(state.dataArray);
            
            // Get bass frequencies (first 10% of spectrum)
            const bassEnd = Math.floor(state.dataArray.length * 0.1);
            let bassSum = 0;
            for (let i = 0; i < bassEnd; i++) {
                bassSum += state.dataArray[i];
            }
            const bassAvg = bassSum / bassEnd;
            
            // Sensitivity from slider (1-100)
            const sensitivity = parseInt(document.getElementById('sensitivitySlider').value);
            const threshold = 255 * (sensitivity / 100);
            
            // Map bass to strobe speed
            if (bassAvg > threshold * 0.5) {
                state.channels.strobe = Math.floor((bassAvg / 255) * 255);
                document.getElementById('strobeSlider').value = state.channels.strobe;
                document.getElementById('strobeDisplay').textContent = state.channels.strobe;
            }
            
            // Map bass to rotation
            if (bassAvg > threshold * 0.3) {
                state.channels.rotation = Math.floor((bassAvg / 255) * 200);
                document.getElementById('rotationSlider').value = state.channels.rotation;
                document.getElementById('rotationDisplay').textContent = state.channels.rotation;
            }
            
            // Bass hits trigger color changes
            if (bassAvg > threshold * 0.8) {
                state.channels.color = Math.floor(Math.random() * 256);
                document.getElementById('colorSlider').value = state.channels.color;
                document.getElementById('colorDisplay').textContent = state.channels.color;
            }
            
            sendDMX();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ') {
                e.preventDefault();
                activateScene('blackout');
            } else if (e.key >= '1' && e.key <= '6') {
                const scenes = ['blackout', 'fullpower', 'slowrotate', 'faststrobe', 'rainbow', 'chaos'];
                const sceneIndex = parseInt(e.key) - 1;
                if (scenes[sceneIndex]) {
                    activateScene(scenes[sceneIndex]);
                }
            }
        });
    </script>
</body>
</html>
